// Copyright (c) 2021, w and contributors
// For license information, please see license.txt


// print heading
//cur_frm.pformat.print_heading = 'Invoice';

{% include 'erpnext/selling/sales_common.js' %};
frappe.provide("erpnext.accounts");
frappe.ui.form.on('Sales Invoice Penjualan Motor Item', {
	/*item_code:function (frm,cdt,cdn) {
		frappe.msgprint("test 123")
	}*/
	item_code: function(doc, cdt, cdn) {
		//frappe.msgprint("item_code")
		var me = this;
		var item = frappe.get_doc(cdt, cdn);
		var update_stock = 0, show_batch_dialog = 0;
		if(['Sales Invoice Penjualan Motor'].includes(cur_frm.doc.doctype)) {
			// frappe.msgprint('massuk bener 123')
			update_stock = cint(cur_frm.doc.update_stock);
			// show_batch_dialog = update_stock;

		} else if((cur_frm.doc.doctype === 'Purchase Receipt' && cur_frm.doc.is_return) ||
			cur_frm.doc.doctype === 'Delivery Note') {
			show_batch_dialog = 1;
		}
		// clear barcode if setting item (else barcode will take priority)
		if (cur_frm.from_barcode == 0) {
			item.barcode = null;
		}
		// this.frm.from_barcode = this.frm.from_barcode - 1 >= 0 ? this.frm.from_barcode - 1 : 0;

		// frappe.msgprint('massuk bener 000000')
		if(item.item_code || item.barcode || item.serial_no) {
			// frappe.msgprint('massuk bener 123666')
			if(!validate_company_and_party()) {
				// frappe.msgprint('massuk bener')
				this.frm.fields_dict["items"].grid.grid_rows[item.idx - 1].remove();
			} else {
				// frappe.msgprint('massuk else')
				return frappe.call({
					method: "erpnext.stock.get_item_details.get_item_details",
					child: item,
					args: {
						doc: cur_frm.doc,
						args: {
							item_code: item.item_code,
							barcode: item.barcode,
							serial_no: item.serial_no,
							batch_no: item.batch_no,
							set_warehouse: cur_frm.doc.set_warehouse,
							warehouse: item.warehouse,
							customer: cur_frm.doc.customer || cur_frm.doc.party_name,
							quotation_to: cur_frm.doc.quotation_to,
							supplier: cur_frm.doc.supplier,
							currency: cur_frm.doc.currency,
							update_stock: update_stock,
							conversion_rate: cur_frm.doc.conversion_rate,
							price_list: cur_frm.doc.selling_price_list || cur_frm.doc.buying_price_list,
							price_list_currency: cur_frm.doc.price_list_currency,
							plc_conversion_rate: cur_frm.doc.plc_conversion_rate,
							company: cur_frm.doc.company,
							order_type: cur_frm.doc.order_type,
							is_pos: cint(cur_frm.doc.is_pos),
							is_return: cint(cur_frm.doc.is_return),
							is_subcontracted: cur_frm.doc.is_subcontracted,
							transaction_date: cur_frm.doc.transaction_date || cur_frm.doc.posting_date,
							ignore_pricing_rule: cur_frm.doc.ignore_pricing_rule,
							doctype: cur_frm.doc.doctype,
							name: cur_frm.doc.name,
							project: item.project || cur_frm.doc.project,
							qty: item.qty || 1,
							stock_qty: item.stock_qty,
							conversion_factor: item.conversion_factor,
							weight_per_unit: item.weight_per_unit,
							weight_uom: item.weight_uom,
							manufacturer: item.manufacturer,
							stock_uom: item.stock_uom,
							pos_profile: cur_frm.doc.doctype == 'Sales Invoice Penjualan Motor' ? cur_frm.doc.pos_profile : '',
							cost_center: item.cost_center,
							tax_category: cur_frm.doc.tax_category,
							item_tax_template: item.item_tax_template,
							child_docname: item.name
						}
					},

					callback: function(r) {
						// frappe.msgprint('masuk munculin coba item name')
						if(!r.exc) {
							// frappe.msgprint("achmad shonri")
							frappe.run_serially([
								() => {
									var d = locals[cdt][cdn];
									// console.log(d)
									add_taxes_from_item_tax_template(d.item_tax_rate);
									if (d.free_item_data) {
										apply_product_discount(d);
									}
								},
								() => {
									// for internal customer instead of pricing rule directly apply valuation rate on item
									if (cur_frm.doc.is_internal_customer || cur_frm.doc.is_internal_supplier) {
										get_incoming_rate(item, cur_frm.posting_date, cur_frm.posting_time,
											cur_frm.doc.do// Copyright (c) 2021, w and contributors
// For license information, please see license.txt


// print heading
//cur_frm.pformat.print_heading = 'Invoice';

{% include 'erpnext/selling/sales_common.js' %};
frappe.provide("erpnext.accounts");
frappe.ui.form.on('Sales Invoice Penjualan Motor Item', {
	/*item_code:function (frm,cdt,cdn) {
		frappe.msgprint("test 123")
	}*/
	item_code: function(doc, cdt, cdn) {
		//frappe.msgprint("item_code")
		var me = this;
		var item = frappe.get_doc(cdt, cdn);
		var update_stock = 0, show_batch_dialog = 0;
		if(['Sales Invoice Penjualan Motor'].includes(cur_frm.doc.doctype)) {
			// frappe.msgprint('massuk bener 123')
			update_stock = cint(cur_frm.doc.update_stock);
			// show_batch_dialog = update_stock;

		} else if((cur_frm.doc.doctype === 'Purchase Receipt' && cur_frm.doc.is_return) ||
			cur_frm.doc.doctype === 'Delivery Note') {
			show_batch_dialog = 1;
		}
		// clear barcode if setting item (else barcode will take priority)
		if (cur_frm.from_barcode == 0) {
			item.barcode = null;
		}
		// this.frm.from_barcode = this.frm.from_barcode - 1 >= 0 ? this.frm.from_barcode - 1 : 0;

		// frappe.msgprint('massuk bener 000000')
		if(item.item_code || item.barcode || item.serial_no) {
			// frappe.msgprint('massuk bener 123666')
			if(!validate_company_and_party()) {
				// frappe.msgprint('massuk bener')
				this.frm.fields_dict["items"].grid.grid_rows[item.idx - 1].remove();
			} else {
				// frappe.msgprint('massuk else')
				return frappe.call({
					method: "erpnext.stock.get_item_details.get_item_details",
					child: item,
					args: {
						doc: cur_frm.doc,
						args: {
							item_code: item.item_code,
							barcode: item.barcode,
							serial_no: item.serial_no,
							batch_no: item.batch_no,
							set_warehouse: cur_frm.doc.set_warehouse,
							warehouse: item.warehouse,
							customer: cur_frm.doc.customer || cur_frm.doc.party_name,
							quotation_to: cur_frm.doc.quotation_to,
							supplier: cur_frm.doc.supplier,
							currency: cur_frm.doc.currency,
							update_stock: update_stock,
							conversion_rate: cur_frm.doc.conversion_rate,
							price_list: cur_frm.doc.selling_price_list || cur_frm.doc.buying_price_list,
							price_list_currency: cur_frm.doc.price_list_currency,
							plc_conversion_rate: cur_frm.doc.plc_conversion_rate,
							company: cur_frm.doc.company,
							order_type: cur_frm.doc.order_type,
							is_pos: cint(cur_frm.doc.is_pos),
							is_return: cint(cur_frm.doc.is_return),
							is_subcontracted: cur_frm.doc.is_subcontracted,
							transaction_date: cur_frm.doc.transaction_date || cur_frm.doc.posting_date,
							ignore_pricing_rule: cur_frm.doc.ignore_pricing_rule,
							doctype: cur_frm.doc.doctype,
							name: cur_frm.doc.name,
							project: item.project || cur_frm.doc.project,
							qty: item.qty || 1,
							stock_qty: item.stock_qty,
							conversion_factor: item.conversion_factor,
							weight_per_unit: item.weight_per_unit,
							weight_uom: item.weight_uom,
							manufacturer: item.manufacturer,
							stock_uom: item.stock_uom,
							pos_profile: cur_frm.doc.doctype == 'Sales Invoice Penjualan Motor' ? cur_frm.doc.pos_profile : '',
							cost_center: item.cost_center,
							tax_category: cur_frm.doc.tax_category,
							item_tax_template: item.item_tax_template,
							child_docname: item.name
						}
					},

					callback: function(r) {
						// frappe.msgprint('masuk munculin coba item name')
						if(!r.exc) {
							// frappe.msgprint("achmad shonri")
							frappe.run_serially([
								() => {
									var d = locals[cdt][cdn];
									// console.log(d)
									add_taxes_from_item_tax_template(d.item_tax_rate);
									if (d.free_item_data) {
										apply_product_discount(d);
									}
								},
								() => {
									// for internal customer instead of pricing rule directly apply valuation rate on item
									if (cur_frm.doc.is_internal_customer || cur_frm.doc.is_internal_supplier) {
										get_incoming_rate(item, cur_frm.posting_date, cur_frm.posting_time,
											cur_frm.doc.do